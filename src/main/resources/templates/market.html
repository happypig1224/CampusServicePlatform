<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二手市场 - 绥E站</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <!-- 头部导航 -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="/" class="logo">绥E站</a>
                
                <ul class="nav-links">
                    <li><a href="/">首页</a></li>
                    <li><a href="/forum">校园论坛</a></li>
                    <li><a href="/market" class="active">二手市场</a></li>
                    <li><a href="/lost-found">失物招领</a></li>
                    <li><a href="/errand">校园跑腿</a></li>
                    <li><a href="/resource">资源共享</a></li>
                </ul>
                
                <div class="user-menu">
                    <a href="/login" class="btn btn-primary">登录</a>
                    <a href="/register" class="btn btn-outline">注册</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="main-content">
        <div class="container">
            <!-- 搜索和筛选 -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="搜索商品...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="categorySelect">
                                <option value="">全部分类</option>
                                <!-- 分类选项将通过JavaScript动态加载 -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="sortSelect">
                                <option value="latest">最新发布</option>
                                <option value="price-asc">价格从低到高</option>
                                <option value="price-desc">价格从高到低</option>
                                <option value="popular">最受欢迎</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" id="searchBtn">搜索</button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100" id="publishBtn">发布商品</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- 左侧分类导航 -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">商品分类</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="categoryList">
                                <!-- 分类列表将通过JavaScript动态加载 -->
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 热门商品 -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="card-title mb-0">热门商品</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="hotProductsList">
                                <!-- 热门商品将通过JavaScript动态加载 -->
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 中间商品列表 -->
                <div class="col-md-9">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0" id="categoryTitle">全部商品</h5>
                            <div class="d-flex align-items-center">
                                <div class="form-check form-switch me-3">
                                    <input class="form-check-input" type="checkbox" id="onlyOnSale">
                                    <label class="form-check-label" for="onlyOnSale">仅显示在售商品</label>
                                </div>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="viewMode" id="gridView" autocomplete="off" checked>
                                    <label class="btn btn-outline-secondary" for="gridView">
                                        <i class="bi bi-grid-3x3-gap"></i>
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="viewMode" id="listView" autocomplete="off">
                                    <label class="btn btn-outline-secondary" for="listView">
                                        <i class="bi bi-list"></i>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- 商品列表 -->
                            <div id="productList" class="row g-4">
                                <!-- 商品列表将通过JavaScript动态加载 -->
                                <div class="col-12 text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 分页 -->
                            <div class="d-flex justify-content-center mt-4">
                                <nav aria-label="商品分页">
                                    <ul class="pagination" id="pagination">
                                        <!-- 分页将通过JavaScript动态生成 -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 发布商品模态框 -->
    <div class="modal fade" id="publishProductModal" tabindex="-1" aria-labelledby="publishProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="publishProductModalLabel">发布商品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="publishProductForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productCategory" class="form-label">商品分类 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="productCategory" name="categoryId" required>
                                        <option value="">请选择分类</option>
                                        <!-- 分类选项将通过JavaScript动态加载 -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productPrice" class="form-label">价格 (元) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="productPrice" name="price" min="0" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productTitle" class="form-label">商品标题 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">商品描述 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="productDescription" name="description" rows="5" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productOriginalPrice" class="form-label">原价 (元)</label>
                                    <input type="number" class="form-control" id="productOriginalPrice" name="originalPrice" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productLocation" class="form-label">交易地点</label>
                                    <input type="text" class="form-control" id="productLocation" name="location" placeholder="如：XX大学北门">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productContactPhone" class="form-label">联系电话</label>
                                    <input type="tel" class="form-control" id="productContactPhone" name="contactPhone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productContactWechat" class="form-label">联系微信</label>
                                    <input type="text" class="form-control" id="productContactWechat" name="contactWechat">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productImages" class="form-label">商品图片</label>
                            <input type="file" class="form-control" id="productImages" multiple accept="image/*">
                            <div class="form-text">支持多张图片上传，建议上传清晰、真实的商品图片</div>
                            <div id="imagePreview" class="mt-2 d-flex flex-wrap gap-2">
                                <!-- 图片预览区域 -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitProductBtn">发布</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 商品详情模态框 -->
    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailModalLabel">商品详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="productImageCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner" id="productCarouselInner">
                                    <!-- 商品图片将通过JavaScript动态加载 -->
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productImageCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productImageCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 id="detailTitle"></h4>
                            <div class="mb-3">
                                <span class="h3 text-danger" id="detailPrice"></span>
                                <span class="text-muted text-decoration-line-through" id="detailOriginalPrice"></span>
                            </div>
                            <div class="mb-3">
                                <span class="badge bg-secondary me-2" id="detailCategory"></span>
                                <span class="badge bg-info me-2" id="detailStatus"></span>
                            </div>
                            <div class="mb-3">
                                <p id="detailDescription"></p>
                            </div>
                            <div class="mb-3">
                                <p><strong>交易地点：</strong><span id="detailLocation"></span></p>
                                <p><strong>联系方式：</strong><span id="detailContact"></span></p>
                                <p><strong>发布时间：</strong><span id="detailCreateTime"></span></p>
                                <p><strong>浏览次数：</strong><span id="detailViewCount"></span></p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" id="collectBtn">收藏</button>
                                <button class="btn btn-success" id="orderBtn" disabled>下单</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>
    <script>
        // 全局变量
        let currentCategory = null;
        let currentPage = 1;
        let currentSort = 'latest';
        let currentKeyword = '';
        let onlyOnSale = false;
        let viewMode = 'grid'; // grid 或 list
        let uploadedImages = [];
        
        // 页面初始化函数
        function pageInit() {
            // 加载分类列表
            loadCategories();
            
            // 加载热门商品
            loadHotProducts();
            
            // 加载商品列表
            loadProducts();
            
            // 绑定事件
            bindEvents();
        }
        
        // 绑定事件
        function bindEvents() {
            // 搜索
            document.getElementById('searchBtn').addEventListener('click', function() {
                currentKeyword = document.getElementById('searchInput').value.trim();
                currentPage = 1;
                loadProducts();
            });
            
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    currentKeyword = this.value.trim();
                    currentPage = 1;
                    loadProducts();
                }
            });
            
            // 分类筛选
            document.getElementById('categorySelect').addEventListener('change', function() {
                currentCategory = this.value ? parseInt(this.value) : null;
                currentPage = 1;
                loadProducts();
            });
            
            // 排序
            document.getElementById('sortSelect').addEventListener('change', function() {
                currentSort = this.value;
                currentPage = 1;
                loadProducts();
            });
            
            // 仅显示在售商品
            document.getElementById('onlyOnSale').addEventListener('change', function() {
                onlyOnSale = this.checked;
                currentPage = 1;
                loadProducts();
            });
            
            // 视图模式切换
            document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    viewMode = this.id;
                    renderProducts(window.currentProducts || []);
                });
            });
            
            // 发布商品按钮
            document.getElementById('publishBtn').addEventListener('click', function() {
                // 检查用户是否登录
                if (!localStorage.getItem('token')) {
                    showMessage('请先登录后再发布商品', 'warning');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000);
                    return;
                }
                
                // 打开发布商品模态框
                const modal = new bootstrap.Modal(document.getElementById('publishProductModal'));
                modal.show();
                
                // 加载分类选项
                loadCategoryOptions();
            });
            
            // 商品图片上传
            document.getElementById('productImages').addEventListener('change', handleImageUpload);
            
            // 提交商品
            document.getElementById('submitProductBtn').addEventListener('click', submitProduct);
        }
        
        // 加载分类列表
        async function loadCategories() {
            try {
                const categories = await get('/market/categories');
                renderCategories(categories);
                renderCategoryOptions(categories);
            } catch (error) {
                console.error('加载分类列表失败:', error);
                document.getElementById('categoryList').innerHTML = '<div class="p-3 text-muted">加载失败</div>';
            }
        }
        
        // 渲染分类列表
        function renderCategories(categories) {
            const container = document.getElementById('categoryList');
            
            // 添加"全部商品"选项
            let html = `
                <a href="#" class="list-group-item list-group-item-action ${!currentCategory ? 'active' : ''}" data-category-id="">
                    <i class="bi bi-grid-3x3-gap me-2"></i>全部商品
                </a>
            `;
            
            // 添加分类
            categories.forEach(category => {
                html += `
                    <a href="#" class="list-group-item list-group-item-action ${currentCategory === category.id ? 'active' : ''}" 
                       data-category-id="${category.id}">
                        <i class="bi ${category.icon || 'bi-tag'} me-2"></i>${category.name}
                        <span class="badge bg-secondary rounded-pill float-end">${category.productCount || 0}</span>
                    </a>
                `;
            });
            
            container.innerHTML = html;
            
            // 绑定点击事件
            container.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 更新活动状态
                    container.querySelectorAll('a').forEach(item => item.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 更新当前分类
                    currentCategory = this.dataset.categoryId ? parseInt(this.dataset.categoryId) : null;
                    currentPage = 1;
                    
                    // 更新标题
                    const categoryName = this.textContent.trim().split('\n')[0];
                    document.getElementById('categoryTitle').textContent = categoryName;
                    document.getElementById('categorySelect').value = currentCategory || '';
                    
                    // 重新加载商品
                    loadProducts();
                });
            });
        }
        
        // 渲染分类选项
        function renderCategoryOptions(categories) {
            const select = document.getElementById('categorySelect');
            
            let html = '<option value="">全部分类</option>';
            categories.forEach(category => {
                html += `<option value="${category.id}">${category.name}</option>`;
            });
            
            select.innerHTML = html;
        }
        
        // 加载分类选项（用于发布商品）
        async function loadCategoryOptions() {
            try {
                const categories = await get('/market/categories');
                const select = document.getElementById('productCategory');
                
                let html = '<option value="">请选择分类</option>';
                categories.forEach(category => {
                    html += `<option value="${category.id}">${category.name}</option>`;
                });
                
                select.innerHTML = html;
            } catch (error) {
                console.error('加载分类选项失败:', error);
            }
        }
        
        // 加载热门商品
        async function loadHotProducts() {
            try {
                const products = await get('/market/products/hot', { limit: 10 });
                renderHotProducts(products);
            } catch (error) {
                console.error('加载热门商品失败:', error);
                document.getElementById('hotProductsList').innerHTML = '<div class="p-3 text-muted">加载失败</div>';
            }
        }
        
        // 渲染热门商品
        function renderHotProducts(products) {
            const container = document.getElementById('hotProductsList');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<div class="p-3 text-muted">暂无热门商品</div>';
                return;
            }
            
            container.innerHTML = products.map(product => `
                <a href="#" class="list-group-item list-group-item-action product-item" data-product-id="${product.id}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${product.title}</h6>
                        <small class="text-danger">¥${product.price}</small>
                    </div>
                    <p class="mb-1 text-truncate">${product.description}</p>
                    <small>${product.categoryName} · ${formatDate(product.createTime)}</small>
                </a>
            `).join('');
            
            // 绑定点击事件
            container.querySelectorAll('.product-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const productId = this.dataset.productId;
                    showProductDetail(productId);
                });
            });
        }
        
        // 加载商品列表
        async function loadProducts() {
            try {
                // 显示加载状态
                document.getElementById('productList').innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                `;
                
                // 构建请求参数
                const params = {
                    page: currentPage,
                    limit: 12,
                    sort: currentSort
                };
                
                if (currentCategory) {
                    params.categoryId = currentCategory;
                }
                
                if (currentKeyword) {
                    params.keyword = currentKeyword;
                }
                
                if (onlyOnSale) {
                    params.status = 'ON_SALE';
                }
                
                // 发送请求
                const response = await get('/market/products', params);
                
                // 保存当前商品数据
                window.currentProducts = response.products;
                
                // 渲染商品列表
                renderProducts(response.products);
                
                // 渲染分页
                renderPagination(response.pagination);
                
            } catch (error) {
                console.error('加载商品列表失败:', error);
                document.getElementById('productList').innerHTML = '<div class="col-12 text-center py-5 text-muted">加载失败，请稍后重试</div>';
            }
        }
        
        // 渲染商品列表
        function renderProducts(products) {
            const container = document.getElementById('productList');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-5 text-muted">暂无商品</div>';
                return;
            }
            
            // 根据视图模式渲染
            if (viewMode === 'grid') {
                container.className = 'row g-4';
                container.innerHTML = products.map(product => `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 product-item" data-product-id="${product.id}">
                            <div class="product-image-container position-relative">
                                ${product.images && product.images.length > 0 ? 
                                    `<img src="${product.images[0]}" class="card-img-top product-image" alt="${product.title}">` :
                                    `<img src="/images/default-product.jpg" class="card-img-top product-image" alt="${product.title}">`
                                }
                                ${product.status === 'SOLD' ? '<div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-50"><span class="badge bg-danger fs-6">已售出</span></div>' : ''}
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${product.title}</h5>
                                <p class="card-text text-truncate">${product.description}</p>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="h5 text-danger mb-0">¥${product.price}</span>
                                        <span class="badge bg-secondary">${product.categoryName}</span>
                                    </div>
                                    <div class="d-flex justify-content-between text-muted small">
                                        <span><i class="bi bi-eye me-1"></i>${formatNumber(product.viewCount)}</span>
                                        <span><i class="bi bi-heart me-1"></i>${formatNumber(product.collectCount)}</span>
                                        <span>${formatDate(product.createTime)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.className = '';
                container.innerHTML = products.map(product => `
                    <div class="card mb-3 product-item" data-product-id="${product.id}">
                        <div class="row g-0">
                            <div class="col-md-3">
                                ${product.images && product.images.length > 0 ? 
                                    `<img src="${product.images[0]}" class="img-fluid rounded-start h-100 object-fit-cover" alt="${product.title}">` :
                                    `<img src="/images/default-product.jpg" class="img-fluid rounded-start h-100 object-fit-cover" alt="${product.title}">`
                                }
                            </div>
                            <div class="col-md-9">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h5 class="card-title">${product.title}</h5>
                                            <p class="card-text text-truncate">${product.description}</p>
                                        </div>
                                        <div class="text-end">
                                            <div class="h4 text-danger">¥${product.price}</div>
                                            <span class="badge bg-secondary">${product.categoryName}</span>
                                            ${product.status === 'SOLD' ? '<span class="badge bg-danger ms-1">已售出</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <div class="text-muted small">
                                            <span><i class="bi bi-eye me-1"></i>${formatNumber(product.viewCount)}</span>
                                            <span class="ms-3"><i class="bi bi-heart me-1"></i>${formatNumber(product.collectCount)}</span>
                                            <span class="ms-3">${formatDate(product.createTime)}</span>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary me-2 collect-btn" data-product-id="${product.id}">收藏</button>
                                            ${product.status !== 'SOLD' ? `<button class="btn btn-sm btn-success order-btn" data-product-id="${product.id}">下单</button>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // 绑定商品点击事件
            container.querySelectorAll('.product-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // 如果点击的是按钮，不触发商品详情
                    if (e.target.classList.contains('btn')) return;
                    
                    const productId = this.dataset.productId;
                    showProductDetail(productId);
                });
            });
            
            // 绑定收藏按钮事件
            container.querySelectorAll('.collect-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    toggleCollect(productId, this);
                });
            });
            
            // 绑定下单按钮事件
            container.querySelectorAll('.order-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    createOrder(productId);
                });
            });
        }
        
        // 渲染分页
        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            
            if (!pagination || pagination.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // 上一页
            if (pagination.hasPrev) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.prevPage}">上一页</a>
                </li>`;
            }
            
            // 页码
            for (let i = 1; i <= pagination.totalPages; i++) {
                if (i === 1 || i === pagination.totalPages || (i >= pagination.currentPage - 2 && i <= pagination.currentPage + 2)) {
                    html += `<li class="page-item ${i === pagination.currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>`;
                } else if (i === pagination.currentPage - 3 || i === pagination.currentPage + 3) {
                    html += `<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`;
                }
            }
            
            // 下一页
            if (pagination.hasNext) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.nextPage}">下一页</a>
                </li>`;
            }
            
            container.innerHTML = html;
            
            // 绑定点击事件
            container.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.dataset.page);
                    if (page && page !== currentPage) {
                        currentPage = page;
                        loadProducts();
                    }
                });
            });
        }
        
        // 处理图片上传
        function handleImageUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('imagePreview');
            
            // 清空预览和已上传图片列表
            preview.innerHTML = '';
            uploadedImages = [];
            
            // 处理每个文件
            Array.from(files).forEach(file => {
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    showMessage('只能上传图片文件', 'warning');
                    return;
                }
                
                // 检查文件大小（限制为5MB）
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('图片大小不能超过5MB', 'warning');
                    return;
                }
                
                // 创建预览
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'position-relative';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" data-index="${uploadedImages.length}">
                            <i class="bi bi-x"></i>
                        </button>
                    `;
                    preview.appendChild(div);
                    
                    // 添加到已上传图片列表
                    uploadedImages.push({
                        file: file,
                        url: e.target.result
                    });
                    
                    // 绑定删除按钮事件
                    div.querySelector('button').addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        uploadedImages.splice(index, 1);
                        div.remove();
                        
                        // 更新剩余按钮的索引
                        preview.querySelectorAll('button').forEach((btn, i) => {
                            btn.dataset.index = i;
                        });
                    });
                };
                reader.readAsDataURL(file);
            });
        }
        
        // 提交商品
        async function submitProduct() {
            const form = document.getElementById('publishProductForm');
            const formData = serializeForm(form);
            
            // 验证表单
            if (!formData.categoryId) {
                showMessage('请选择商品分类', 'warning');
                return;
            }
            
            if (!formData.title.trim()) {
                showMessage('请输入商品标题', 'warning');
                return;
            }
            
            if (!formData.description.trim()) {
                showMessage('请输入商品描述', 'warning');
                return;
            }
            
            if (!formData.price || formData.price <= 0) {
                showMessage('请输入有效的商品价格', 'warning');
                return;
            }
            
            try {
                // 显示加载状态
                const submitBtn = document.getElementById('submitProductBtn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '发布中...';
                submitBtn.disabled = true;
                
                // 创建FormData对象用于上传文件
                const productFormData = new FormData();
                
                // 添加表单字段
                Object.keys(formData).forEach(key => {
                    if (formData[key] !== null && formData[key] !== undefined) {
                        productFormData.append(key, formData[key]);
                    }
                });
                
                // 添加图片文件
                uploadedImages.forEach(image => {
                    productFormData.append('images', image.file);
                });
                
                // 发送请求
                await post('/market/products', productFormData);
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('publishProductModal'));
                modal.hide();
                
                // 重置表单
                form.reset();
                document.getElementById('imagePreview').innerHTML = '';
                uploadedImages = [];
                
                // 显示成功消息
                showMessage('商品发布成功，等待审核', 'success');
                
                // 重新加载商品列表
                loadProducts();
                
            } catch (error) {
                console.error('发布商品失败:', error);
                showMessage(error.message || '发布商品失败，请稍后重试', 'danger');
            } finally {
                // 恢复按钮状态
                const submitBtn = document.getElementById('submitProductBtn');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // 显示商品详情
        async function showProductDetail(productId) {
            try {
                // 获取商品详情
                const product = await get(`/market/products/${productId}`);
                
                // 填充商品详情
                document.getElementById('detailTitle').textContent = product.title;
                document.getElementById('detailPrice').textContent = `¥${product.price}`;
                document.getElementById('detailOriginalPrice').textContent = product.originalPrice ? `¥${product.originalPrice}` : '';
                document.getElementById('detailCategory').textContent = product.categoryName;
                document.getElementById('detailStatus').textContent = getStatusText(product.status);
                document.getElementById('detailDescription').textContent = product.description;
                document.getElementById('detailLocation').textContent = product.location || '未提供';
                document.getElementById('detailContact').textContent = getContactText(product);
                document.getElementById('detailCreateTime').textContent = formatDate(product.createTime);
                document.getElementById('detailViewCount').textContent = formatNumber(product.viewCount);
                
                // 设置状态样式
                const statusBadge = document.getElementById('detailStatus');
                statusBadge.className = `badge bg-${getStatusColor(product.status)}`;
                
                // 渲染商品图片
                renderProductImages(product.images);
                
                // 设置收藏按钮状态
                const collectBtn = document.getElementById('collectBtn');
                collectBtn.textContent = product.isCollected ? '已收藏' : '收藏';
                collectBtn.className = product.isCollected ? 'btn btn-secondary' : 'btn btn-primary';
                
                // 设置下单按钮状态
                const orderBtn = document.getElementById('orderBtn');
                if (product.status === 'ON_SALE' && product.userId !== getCurrentUserId()) {
                    orderBtn.disabled = false;
                    orderBtn.onclick = function() {
                        createOrder(productId);
                    };
                } else {
                    orderBtn.disabled = true;
                    if (product.status === 'SOLD') {
                        orderBtn.textContent = '已售出';
                    } else if (product.userId === getCurrentUserId()) {
                        orderBtn.textContent = '自己的商品';
                    }
                }
                
                // 绑定收藏按钮事件
                collectBtn.onclick = function() {
                    toggleCollect(productId, this);
                };
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
                modal.show();
                
            } catch (error) {
                console.error('获取商品详情失败:', error);
                showMessage('获取商品详情失败', 'danger');
            }
        }
        
        // 渲染商品图片
        function renderProductImages(images) {
            const container = document.getElementById('productCarouselInner');
            
            if (!images || images.length === 0) {
                container.innerHTML = `
                    <div class="carousel-item active">
                        <img src="/images/default-product.jpg" class="d-block w-100" alt="商品图片">
                    </div>
                `;
                return;
            }
            
            container.innerHTML = images.map((image, index) => `
                <div class="carousel-item ${index === 0 ? 'active' : ''}">
                    <img src="${image}" class="d-block w-100" alt="商品图片${index + 1}">
                </div>
            `).join('');
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'AUDITING': '审核中',
                'ON_SALE': '在售',
                'SOLD': '已售出',
                'OFF_SHELF': '已下架'
            };
            return statusMap[status] || status;
        }
        
        // 获取状态颜色
        function getStatusColor(status) {
            const colorMap = {
                'AUDITING': 'warning',
                'ON_SALE': 'success',
                'SOLD': 'danger',
                'OFF_SHELF': 'secondary'
            };
            return colorMap[status] || 'secondary';
        }
        
        // 获取联系方式文本
        function getContactText(product) {
            let contact = '';
            if (product.contactPhone) {
                contact += `电话: ${product.contactPhone}`;
            }
            if (product.contactWechat) {
                if (contact) contact += ' | ';
                contact += `微信: ${product.contactWechat}`;
            }
            return contact || '未提供';
        }
        
        // 获取当前用户ID（从本地存储或全局变量中获取）
        function getCurrentUserId() {
            // 这里应该从用户信息中获取，暂时返回null
            return null;
        }
        
        // 切换收藏状态
        async function toggleCollect(productId, button) {
            try {
                // 检查用户是否登录
                if (!localStorage.getItem('token')) {
                    showMessage('请先登录后再收藏商品', 'warning');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000);
                    return;
                }
                
                // 显示加载状态
                const originalText = button.textContent;
                button.textContent = '处理中...';
                button.disabled = true;
                
                // 发送请求
                const isCollected = button.textContent === '已收藏';
                const url = isCollected ? 
                    `/market/products/${productId}/collect` : 
                    `/market/products/${productId}/collect`;
                
                const method = isCollected ? 'DELETE' : 'POST';
                
                await apiRequest(url, { method });
                
                // 更新按钮状态
                if (isCollected) {
                    button.textContent = '收藏';
                    button.className = 'btn btn-primary';
                    showMessage('已取消收藏', 'success');
                } else {
                    button.textContent = '已收藏';
                    button.className = 'btn btn-secondary';
                    showMessage('收藏成功', 'success');
                }
                
            } catch (error) {
                console.error('收藏操作失败:', error);
                showMessage(error.message || '收藏操作失败', 'danger');
                
                // 恢复按钮状态
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // 创建订单
        async function createOrder(productId) {
            try {
                // 检查用户是否登录
                if (!localStorage.getItem('token')) {
                    showMessage('请先登录后再下单', 'warning');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000);
                    return;
                }
                
                // 获取商品信息
                const product = await get(`/market/products/${productId}`);
                
                // 确认下单
                if (!confirm(`确认下单「${product.title}」？价格：¥${product.price}`)) {
                    return;
                }
                
                // 跳转到订单页面
                window.location.href = `/market/order?productId=${productId}`;
                
            } catch (error) {
                console.error('创建订单失败:', error);
                showMessage(error.message || '创建订单失败', 'danger');
            }
        }
    </script>
</body>
</html>